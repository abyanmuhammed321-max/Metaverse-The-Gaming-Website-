<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>LiveChat</title>

<!-- Firebase SDK v9 compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: #fff; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; overflow: hidden; }

#setup-screen {
  position: fixed; inset: 0; background: #fff;
  display: flex; align-items: center; justify-content: center;
  z-index: 9999; flex-direction: column; gap: 0; padding: 20px;
}
.setup-card {
  width: 100%; max-width: 520px; background: #fff;
  border: 2px solid #e0e7ff; border-radius: 16px;
  padding: 32px; box-shadow: 0 8px 40px rgba(79,70,229,.12);
}
.setup-card h1 { font-size: 22px; font-weight: 700; color: #111; margin-bottom: 6px; }
.setup-card p { font-size: 13px; color: #6b7280; margin-bottom: 20px; line-height: 1.6; }
.field-group { margin-bottom: 14px; }
.field-group label { display: block; font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 5px; }
.field-group input {
  width: 100%; padding: 10px 14px; border: 1.5px solid #d1d5db;
  border-radius: 8px; font-size: 13px; font-family: monospace;
  outline: none; transition: border-color .2s; color: #111;
}
.field-group input:focus { border-color: #4f46e5; }
.field-group input::placeholder { color: #9ca3af; font-style: italic; }
.setup-btn {
  width: 100%; padding: 12px; background: linear-gradient(135deg,#4f46e5,#7c3aed);
  color: #fff; border: none; border-radius: 10px; font-size: 15px;
  font-weight: 600; cursor: pointer; transition: opacity .2s;
}
.setup-btn:hover { opacity: .9; }
.setup-btn:disabled { opacity: .5; cursor: not-allowed; }
.steps { background: #f8f9ff; border-radius: 10px; padding: 14px 16px; margin-bottom: 20px; }
.steps ol { padding-left: 18px; }
.steps li { font-size: 12px; color: #4b5563; margin-bottom: 6px; line-height: 1.5; }
.steps li a { color: #4f46e5; text-decoration: none; font-weight: 600; }
.steps li a:hover { text-decoration: underline; }
.err-msg { color: #ef4444; font-size: 12px; margin-top: 8px; display: none; }

#fab {
  position: fixed; bottom: 28px; right: 28px; z-index: 1001;
  width: 58px; height: 58px; border-radius: 50%;
  background: linear-gradient(135deg,#4f46e5,#7c3aed);
  color: #fff; border: none; cursor: pointer;
  box-shadow: 0 6px 24px rgba(79,70,229,.45);
  display: flex; align-items: center; justify-content: center;
  transition: transform .2s, box-shadow .2s;
}
#fab:hover { transform: scale(1.1); box-shadow: 0 10px 30px rgba(79,70,229,.55); }
#badge {
  position: absolute; top: -4px; right: -4px;
  background: #ef4444; color: #fff; font-size: 11px; font-weight: 700;
  border-radius: 999px; min-width: 18px; height: 18px; padding: 0 4px;
  display: none; align-items: center; justify-content: center;
  border: 2px solid #fff;
}
#badge.show { display: flex; }

#sidebar {
  position: fixed; top: 0; right: 0; height: 100vh; width: 370px;
  background: #fff; box-shadow: -4px 0 30px rgba(0,0,0,.12);
  display: flex; flex-direction: column; z-index: 1000;
  transform: translateX(100%); transition: transform .35s cubic-bezier(.4,0,.2,1);
}
#sidebar.open { transform: translateX(0); }

#login-panel {
  display: flex; flex-direction: column; align-items: center;
  justify-content: center; height: 100%; padding: 36px; gap: 20px;
}
.google-signin-btn {
  display: flex; align-items: center; gap: 12px;
  background: #fff; border: 1.5px solid #dadce0; border-radius: 8px;
  padding: 13px 22px; cursor: pointer; font-size: 15px; font-weight: 500;
  color: #3c4043; transition: box-shadow .2s, background .15s;
  width: 100%; justify-content: center;
}
.google-signin-btn:hover { background: #f8f9fa; box-shadow: 0 2px 8px rgba(0,0,0,.12); }
.google-signin-btn:disabled { opacity: .5; cursor: not-allowed; }

#chat-header {
  background: linear-gradient(135deg,#4f46e5,#7c3aed);
  color: #fff; padding: 14px 16px;
  display: flex; align-items: center; gap: 10px; flex-shrink: 0;
}
#user-avatar { width: 38px; height: 38px; border-radius: 50%; border: 2px solid rgba(255,255,255,.5); }
.header-right { margin-left: auto; display: flex; gap: 6px; align-items: center; }
.icon-btn {
  background: rgba(255,255,255,.15); border: none; color: #fff;
  border-radius: 50%; width: 32px; height: 32px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: 15px; transition: background .15s;
}
.icon-btn:hover { background: rgba(255,255,255,.28); }
#online-pill {
  font-size: 11px; background: rgba(255,255,255,.2);
  border-radius: 999px; padding: 3px 10px; white-space: nowrap;
}

#online-bar {
  display: flex; align-items: center; gap: 6px;
  padding: 8px 14px; background: #f8f9ff;
  border-bottom: 1px solid #e8eaf6; overflow-x: auto;
  scrollbar-width: none; flex-shrink: 0; min-height: 44px;
}
#online-bar::-webkit-scrollbar { display: none; }
.user-chip {
  display: flex; align-items: center; gap: 5px;
  background: #fff; border: 1px solid #e0e0e0;
  border-radius: 999px; padding: 3px 10px 3px 3px;
  white-space: nowrap; font-size: 11px; color: #374151;
}
.user-chip img { width: 22px; height: 22px; border-radius: 50%; }
.dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.dot.green { background: #22c55e; }

#messages {
  flex: 1; overflow-y: auto; padding: 14px 12px;
  display: flex; flex-direction: column; gap: 12px;
  background: #fafafa; scroll-behavior: smooth;
}
#messages::-webkit-scrollbar { width: 4px; }
#messages::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }

.msg-row { display: flex; gap: 8px; align-items: flex-end; animation: fadeUp .2s ease; }
.msg-row.mine { flex-direction: row-reverse; }
@keyframes fadeUp { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

.msg-avatar { width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0; object-fit: cover; }
.bubble-wrap { display: flex; flex-direction: column; max-width: 76%; }
.msg-row.mine .bubble-wrap { align-items: flex-end; }
.sender-name { font-size: 10px; color: #9ca3af; margin-bottom: 2px; padding: 0 3px; }
.bubble {
  padding: 9px 13px; border-radius: 16px; font-size: 14px;
  line-height: 1.45; word-break: break-word;
}
.bubble.theirs {
  background: #fff; color: #111; border-radius: 16px 16px 16px 4px;
  box-shadow: 0 1px 4px rgba(0,0,0,.08);
}
.bubble.mine {
  background: linear-gradient(135deg,#4f46e5,#7c3aed);
  color: #fff; border-radius: 16px 16px 4px 16px;
}
.ts { font-size: 10px; color: #9ca3af; margin-top: 2px; padding: 0 3px; }
.msg-row.mine .ts { text-align: right; }

.day-sep { display: flex; align-items: center; gap: 8px; margin: 4px 0; }
.day-sep span { font-size: 11px; color: #9ca3af; white-space: nowrap; }
.day-sep::before, .day-sep::after { content:''; flex:1; height:1px; background:#e5e7eb; }
.sys-msg { text-align: center; font-size: 11px; color: #9ca3af; padding: 2px 0; }

.typing-row { display: flex; gap: 8px; align-items: flex-end; }
.typing-bubble {
  background: #fff; border-radius: 16px 16px 16px 4px;
  box-shadow: 0 1px 4px rgba(0,0,0,.08); padding: 10px 14px;
  display: flex; gap: 4px; align-items: center;
}
.typing-bubble span {
  width: 7px; height: 7px; background: #9ca3af; border-radius: 50%;
  animation: bounce .9s infinite;
}
.typing-bubble span:nth-child(2) { animation-delay: .15s; }
.typing-bubble span:nth-child(3) { animation-delay: .3s; }
@keyframes bounce { 0%,80%,100% { transform:translateY(0); } 40% { transform:translateY(-5px); } }

#input-bar {
  padding: 10px 12px; border-top: 1px solid #e5e7eb;
  background: #fff; display: flex; align-items: flex-end;
  gap: 8px; flex-shrink: 0;
}
#msg-input {
  flex: 1; border: 1.5px solid #e5e7eb; border-radius: 22px;
  padding: 9px 14px; font-size: 14px; outline: none; resize: none;
  transition: border-color .2s; max-height: 100px; line-height: 1.4;
  font-family: inherit; background: #fafafa;
}
#msg-input:focus { border-color: #4f46e5; background: #fff; }
#send-btn {
  background: linear-gradient(135deg,#4f46e5,#7c3aed); color: #fff;
  border: none; border-radius: 50%; width: 38px; height: 38px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; flex-shrink: 0; transition: transform .15s, opacity .2s;
}
#send-btn:hover { transform: scale(1.1); }
#send-btn:disabled { opacity: .4; cursor: not-allowed; transform: none; }

.spinner {
  width: 18px; height: 18px; border: 2px solid rgba(255,255,255,.3);
  border-top-color: #fff; border-radius: 50%; animation: spin .7s linear infinite;
  display: inline-block;
}
@keyframes spin { to { transform: rotate(360deg); } }

#emoji-btn { background: none; border: none; font-size: 20px; cursor: pointer; padding: 4px; line-height: 1; }
</style>
</head>
<body>

<div id="setup-screen">
  <div class="setup-card">
    <h1>üí¨ LiveChat Setup</h1>
    <p>Enter your Firebase project config below. This is a one-time setup ‚Äî your config will be saved in the browser so you never need to enter it again.</p>
    <div class="steps">
      <ol>
        <li>Go to <a href="https://console.firebase.google.com" target="_blank">console.firebase.google.com</a> ‚Üí Create a project</li>
        <li><strong>Authentication</strong> ‚Üí Get started ‚Üí Enable <strong>Google</strong> sign-in</li>
        <li><strong>Realtime Database</strong> ‚Üí Create database ‚Üí <strong>Test mode</strong></li>
        <li>Project Settings (‚öôÔ∏è) ‚Üí "Your apps" ‚Üí Add Web app ‚Üí Copy config</li>
      </ol>
    </div>
    <div class="field-group">
      <label>API Key</label>
      <input id="cfg-apiKey" placeholder="AIzaSy..." autocomplete="off"/>
    </div>
    <div class="field-group">
      <label>Auth Domain</label>
      <input id="cfg-authDomain" placeholder="your-project.firebaseapp.com"/>
    </div>
    <div class="field-group">
      <label>Database URL</label>
      <input id="cfg-databaseURL" placeholder="https://your-project-default-rtdb.firebaseio.com"/>
    </div>
    <div class="field-group">
      <label>Project ID</label>
      <input id="cfg-projectId" placeholder="your-project-id"/>
    </div>
    <div class="field-group">
      <label>App ID</label>
      <input id="cfg-appId" placeholder="1:123456789:web:abc..."/>
    </div>
    <div id="setup-err" class="err-msg"></div>
    <br/>
    <button class="setup-btn" onclick="saveConfig()">Save Config & Start Chatting ‚Üí</button>
    <p style="font-size:11px;color:#9ca3af;text-align:center;margin-top:14px;">
      Your config is stored only in your browser (localStorage). Never shared.
    </p>
  </div>
</div>

<button id="fab" onclick="toggleSidebar()" style="display:none;">
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
    <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z" fill="white"/>
  </svg>
  <div id="badge"></div>
</button>

<div id="sidebar">
  <div id="login-panel">
    <div style="text-align:center;">
      <div style="font-size:48px;margin-bottom:10px;">üí¨</div>
      <h2 style="font-size:22px;font-weight:700;color:#111;margin-bottom:6px;">LiveChat</h2>
      <p style="color:#6b7280;font-size:14px;line-height:1.5;">
        Sign in with your real Google account<br>and chat with your real friends instantly.
      </p>
    </div>
    <button class="google-signin-btn" id="google-btn" onclick="signInWithGoogle()">
      <svg width="20" height="20" viewBox="0 0 48 48">
        <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
        <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
        <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
        <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.35-8.16 2.35-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
      </svg>
      Sign in with Google
    </button>
    <p style="font-size:11px;color:#9ca3af;text-align:center;">
      Share this page link with friends so they can join and chat with you live.
    </p>
  </div>

  <div id="chat-panel" style="display:none;flex-direction:column;height:100%;">
    <div id="chat-header">
      <img id="user-avatar" src="" alt="" style="width:38px;height:38px;border-radius:50%;border:2px solid rgba(255,255,255,.5);"/>
      <div>
        <div id="user-name" style="font-weight:600;font-size:14px;"></div>
        <div style="font-size:11px;opacity:.75;">‚óè Online</div>
      </div>
      <div class="header-right">
        <span id="online-pill"></span>
        <button class="icon-btn" onclick="toggleSidebar()" title="Close">‚úï</button>
        <button class="icon-btn" onclick="signOut()" title="Sign out" style="font-size:12px;">‚èª</button>
      </div>
    </div>
    <div id="online-bar">
      <span style="font-size:11px;color:#9ca3af;flex-shrink:0;">Online:</span>
    </div>
    <div id="messages"></div>
    <div id="input-bar">
      <button id="emoji-btn" title="Emoji" onclick="toggleEmoji()">üòä</button>
      <textarea id="msg-input" rows="1" placeholder="Type a message‚Ä¶"
        onkeydown="handleKey(event)" oninput="autoResize(this);handleTyping()"></textarea>
      <button id="send-btn" onclick="sendMessage()" disabled>
        <svg width="17" height="17" viewBox="0 0 24 24" fill="none">
          <path d="M22 2L11 13" stroke="white" stroke-width="2.2" stroke-linecap="round"/>
          <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
    <div id="emoji-picker" style="display:none;padding:8px 12px;background:#fff;border-top:1px solid #e5e7eb;flex-wrap:wrap;gap:6px;flex-shrink:0;"></div>
  </div>
</div>

<script>
let db, auth, currentUser, presenceRef;
let sidebarOpen = false;
let unreadCount = 0;
let typingTimeout = null;
const EMOJIS = ['üòä','üòÇ','‚ù§Ô∏è','üëç','üî•','üéâ','üòç','ü§î','üëã','üòé','üôè','‚úÖ','üöÄ','üíØ','üòÖ','ü§£','üò≠','üí™','ü´°','üòÅ'];

function saveConfig() {
  const cfg = {
    apiKey:      document.getElementById('cfg-apiKey').value.trim(),
    authDomain:  document.getElementById('cfg-authDomain').value.trim(),
    databaseURL: document.getElementById('cfg-databaseURL').value.trim(),
    projectId:   document.getElementById('cfg-projectId').value.trim(),
    appId:       document.getElementById('cfg-appId').value.trim(),
  };
  const err = document.getElementById('setup-err');
  if (!cfg.apiKey || !cfg.authDomain || !cfg.databaseURL || !cfg.projectId || !cfg.appId) {
    err.textContent = 'Please fill in all fields.'; err.style.display = 'block'; return;
  }
  if (!cfg.databaseURL.startsWith('https://')) {
    err.textContent = 'Database URL must start with https://'; err.style.display = 'block'; return;
  }
  localStorage.setItem('livechat_firebase_cfg', JSON.stringify(cfg));
  err.style.display = 'none';
  initFirebase(cfg);
}

function loadSavedConfig() {
  const saved = localStorage.getItem('livechat_firebase_cfg');
  if (saved) { try { initFirebase(JSON.parse(saved)); return true; } catch(e) {} }
  return false;
}

function initFirebase(cfg) {
  try {
    if (!firebase.apps.length) firebase.initializeApp(cfg);
    db = firebase.database();
    auth = firebase.auth();
    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('fab').style.display = 'flex';
    sidebarOpen = true;
    document.getElementById('sidebar').classList.add('open');
    auth.onAuthStateChanged(user => {
      if (user) { currentUser = user; onLoggedIn(user); }
      else { currentUser = null; showLoginPanel(); }
    });
    buildEmojiPicker();
  } catch(e) {
    const err = document.getElementById('setup-err');
    err.textContent = 'Firebase error: ' + e.message;
    err.style.display = 'block';
    document.getElementById('setup-screen').style.display = 'flex';
    document.getElementById('fab').style.display = 'none';
  }
}

function signInWithGoogle() {
  const btn = document.getElementById('google-btn');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div> Signing in‚Ä¶';
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).catch(err => {
    btn.disabled = false;
    btn.innerHTML = 'Sign in with Google';
    alert('Sign-in failed: ' + err.message);
  });
}

function signOut() {
  if (presenceRef) presenceRef.remove();
  auth.signOut();
}

function onLoggedIn(user) {
  presenceRef = db.ref('presence/' + user.uid);
  presenceRef.set({ name: user.displayName, photo: user.photoURL, uid: user.uid });
  presenceRef.onDisconnect().remove();
  document.getElementById('user-avatar').src = user.photoURL || fallbackAvatar(user.displayName);
  document.getElementById('user-name').textContent = user.displayName;
  document.getElementById('login-panel').style.display = 'none';
  document.getElementById('chat-panel').style.display = 'flex';
  document.getElementById('send-btn').disabled = false;
  document.getElementById('msg-input').disabled = false;
  listenPresence();
  loadMessages();
}

function showLoginPanel() {
  document.getElementById('login-panel').style.display = 'flex';
  document.getElementById('chat-panel').style.display = 'none';
  const btn = document.getElementById('google-btn');
  btn.disabled = false;
  btn.innerHTML = 'Sign in with Google';
}

function listenPresence() {
  db.ref('presence').on('value', snap => {
    const bar = document.getElementById('online-bar');
    bar.innerHTML = '<span style="font-size:11px;color:#9ca3af;flex-shrink:0;">Online:</span>';
    let count = 0;
    snap.forEach(child => {
      const u = child.val(); count++;
      const chip = document.createElement('div');
      chip.className = 'user-chip';
      chip.innerHTML = `<img src="${escHtml(u.photo || fallbackAvatar(u.name))}" onerror="this.src='${fallbackAvatar(u.name)}'">
        <div class="dot green"></div>${escHtml(firstName(u.name))}`;
      bar.appendChild(chip);
    });
    document.getElementById('online-pill').textContent = `‚óè ${count} online`;
  });
}

let lastDate = null;
let initialLoad = true;

function loadMessages() {
  const msgsEl = document.getElementById('messages');
  msgsEl.innerHTML = ''; lastDate = null;
  const msgsRef = db.ref('messages').limitToLast(100);
  msgsRef.once('value', snap => {
    snap.forEach(child => renderMsg(child.val(), false));
    scrollBottom(); initialLoad = false;
  });
  msgsRef.on('child_added', snap => {
    if (!initialLoad) { renderMsg(snap.val(), true); if (!sidebarOpen) addUnread(); }
  });
}

function renderMsg(msg, animate) {
  const msgsEl = document.getElementById('messages');
  const isMine = currentUser && msg.uid === currentUser.uid;
  const d = new Date(msg.ts);
  const dateStr = d.toLocaleDateString([], { weekday:'long', month:'short', day:'numeric' });
  if (dateStr !== lastDate) {
    lastDate = dateStr;
    const sep = document.createElement('div');
    sep.className = 'day-sep';
    sep.innerHTML = `<span>${dateStr}</span>`;
    msgsEl.appendChild(sep);
  }
  const row = document.createElement('div');
  row.className = 'msg-row' + (isMine ? ' mine' : '');
  if (!animate) row.style.animation = 'none';
  row.innerHTML = `
    <img class="msg-avatar" src="${escHtml(msg.photo || fallbackAvatar(msg.name))}"
         onerror="this.src='${fallbackAvatar(msg.name)}'" alt="${escHtml(msg.name)}">
    <div class="bubble-wrap">
      ${!isMine ? `<div class="sender-name">${escHtml(firstName(msg.name))}</div>` : ''}
      <div class="bubble ${isMine ? 'mine' : 'theirs'}">${escHtml(msg.text)}</div>
      <div class="ts">${formatTime(d)}${isMine ? ' ‚úì‚úì' : ''}</div>
    </div>`;
  msgsEl.appendChild(row);
  if (animate) scrollBottom();
}

function sendMessage() {
  const input = document.getElementById('msg-input');
  const text = input.value.trim();
  if (!text || !currentUser) return;
  db.ref('messages').push({ uid: currentUser.uid, name: currentUser.displayName, photo: currentUser.photoURL, text, ts: Date.now() });
  db.ref('typing/' + currentUser.uid).remove();
  clearTimeout(typingTimeout);
  input.value = ''; autoResize(input);
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

function handleTyping() {
  if (!currentUser) return;
  db.ref('typing/' + currentUser.uid).set({ name: currentUser.displayName });
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(() => db.ref('typing/' + currentUser.uid).remove(), 3000);
  document.getElementById('send-btn').disabled = !document.getElementById('msg-input').value.trim();
}

function toggleSidebar() {
  sidebarOpen = !sidebarOpen;
  document.getElementById('sidebar').classList.toggle('open', sidebarOpen);
  if (sidebarOpen) { clearUnread(); scrollBottom(); }
}

function addUnread() {
  unreadCount++;
  const b = document.getElementById('badge');
  b.textContent = unreadCount; b.classList.add('show'); b.style.display = 'flex';
}
function clearUnread() {
  unreadCount = 0;
  const b = document.getElementById('badge');
  b.textContent = ''; b.classList.remove('show'); b.style.display = 'none';
}

function buildEmojiPicker() {
  const picker = document.getElementById('emoji-picker');
  picker.style.display = 'none';
  EMOJIS.forEach(e => {
    const btn = document.createElement('button');
    btn.textContent = e;
    btn.style.cssText = 'background:none;border:none;font-size:22px;cursor:pointer;padding:2px;';
    btn.onclick = () => {
      const input = document.getElementById('msg-input');
      input.value += e; input.focus();
      document.getElementById('send-btn').disabled = !input.value.trim();
    };
    picker.appendChild(btn);
  });
}
function toggleEmoji() {
  const p = document.getElementById('emoji-picker');
  p.style.display = p.style.display === 'none' ? 'flex' : 'none';
}

function formatTime(d) { return d.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' }); }
function firstName(name) { return (name || 'User').split(' ')[0]; }
function scrollBottom() { setTimeout(() => { const m = document.getElementById('messages'); m.scrollTop = m.scrollHeight; }, 60); }
function autoResize(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 100) + 'px'; }
function escHtml(t) { if (!t) return ''; return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function fallbackAvatar(name) { const n = encodeURIComponent((name || 'U').substring(0,2)); return `https://ui-avatars.com/api/?name=${n}&background=4f46e5&color=fff&size=60`; }

window.addEventListener('DOMContentLoaded', () => {
  if (!loadSavedConfig()) document.getElementById('setup-screen').style.display = 'flex';
});
</script>
</body>
</html>
